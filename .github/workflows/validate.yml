name: Validate Plugin

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check plugin.json
        run: |
          if [ ! -f ".claude-plugin/plugin.json" ]; then
            echo "Error: plugin.json not found"
            exit 1
          fi
          echo "plugin.json exists"

      - name: Validate JSON
        run: |
          npm install -g json
          json verify .claude-plugin/plugin.json || true

      - name: Check required files
        run: |
          required_files=(
            ".claude-plugin/plugin.json"
            "agents/insbot-agent.md"
            "commands/insbot.md"
            "commands/keyword.md"
            "commands/url.md"
            "commands/nurture.md"
            "skills/keyword-mode/SKILL.md"
            "skills/url-mode/SKILL.md"
            "skills/nurture-mode/SKILL.md"
            "README.md"
          )
          for file in "${required_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "Error: Required file $file not found"
              exit 1
            fi
            echo "✓ $file"
          done

      - name: Check frontmatter in commands
        run: |
          for cmd in commands/*.md; do
            if ! grep -q "^description:" "$cmd"; then
              echo "Error: $cmd missing description frontmatter"
              exit 1
            fi
            echo "✓ $cmd has frontmatter"
          done

      - name: Check frontmatter in agents
        run: |
          for agent in agents/*.md; do
            if ! grep -q "^name:" "$agent" || ! grep -q "^description:" "$agent"; then
              echo "Error: $agent missing required frontmatter"
              exit 1
            fi
            echo "✓ $agent has frontmatter"
          done
